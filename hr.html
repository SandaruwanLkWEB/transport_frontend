<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>මානව සම්පත් (HR)</title>
  <link rel="stylesheet" href="assets/styles.css" />
  <script src="assets/config.js"></script>
  <script src="assets/app.js"></script>
</head>
<body>
<header>
  <h1>මානව සම්පත් (HR)</h1>
  <div style="display:flex; gap:8px; align-items:center;">
    <a href="index.html">මුල් පිටුව</a>
    <button class="btn secondary small" onclick="logout()">ඉවත් වන්න</button>
  </div>
</header>

<div class="container">
  <div class="card" id="meBox"></div>

  <div class="card">
    <div class="tabs">
      <button class="btn active" id="tabඅනුමත කරන්න" onclick="setTab('approve')">Final Approvals</button>
      <button class="btn" id="tabවාර්තා" onclick="setTab('reports')">වාර්තා</button>
    </div>
  </div>

  <div class="card" id="pane_approve">
    <h2 style="margin:0 0 10px;">TA Assigned ඉල්ලීම්</h2>
    <div style="display:flex; gap:8px; flex-wrap:wrap;">
      <button class="btn ghost" onclick="loadTAඉල්ලීම්()">Refresh</button>
    </div>
    <div class="hr"></div>
    <div id="listBox" class="small">Loading...</div>
  </div>

  <div class="card" id="pane_reports" style="display:none;">
    <h2 style="margin:0 0 10px;">බාගත කරන්න වාර්තා</h2>
    <div class="small">වාර්තා download කරන්නේ HR Final Approval පස්සේම.</div>
    <div class="row">
      <div>
        <label>Request ID</label>
        <input id="repReqId" type="number" placeholder="e.g. 12" />
      </div>
      <div>
        <label>Actions</label>
        <div style="display:flex; gap:8px; flex-wrap:wrap; margin-top:6px;">
          <button class="btn" onclick="downloadRouteReport()">Route-wise PDF</button>
          <button class="btn secondary" onclick="downloadVehicleReport()">Vehicle PDF</button>
        </div>
      </div>
    </div>
  </div>

</div>

<script>
let ME=null;
let LIST=[];

function setTab(tab){
  const tabs = ["approve","reports"];
  for(const t of tabs){
    qs("pane_"+t).style.display = (t===tab) ? "" : "none";
    qs("tab"+t.charAt(0).toUpperCase()+t.slice(1)).classList.toggle("active", t===tab);
  }
}

async function guard(){
  ME = await guardRole("HR");
  if(!ME) return;
  qs("meBox").innerHTML = `<b>${ME.role}</b> | ${ME.email}`;
}

async function loadTARequests(){
  const d = await api("/hr/requests/ta-assigned");
  LIST = d.requests || [];
  render();
}

function render(){
  if(LIST.length===0){ qs("listBox").innerHTML = "<span class='badge good'>බලාපොරොත්තු වූ ඉල්ලීම් නැත</span>"; return; }
  let html = "<div class="table-wrap"><table><tr><th>ID</th><th>දිනය</th><th>වේලාව</th><th>දෙපාර්තමේන්තුව</th><th>තත්ත්වය</th><th>ක්‍රියාව</th></tr>";
  for(const r of LIST){
    html += `<tr>
      <td>${r.id}</td>
      <td>${fmtDate(r.request_date)}</td>
      <td>${fmtTime(r.request_time)}</td>
      <td>${r.department_name}</td>
      <td>${statusBadge(r.status)}</td>
      <td>
        ${r.status==="TA_ASSIGNED_PENDING_HR" ? `
        <button class="btn small" onclick="overඅනුමත(${r.id})">ඔවරයිඩ් අනුමත කරන්න</button>
        <button class="btn small secondary" onclick="overප්‍රතික්ෂේප(${r.id})">ඔවරයිඩ් ප්‍රතික්ෂේප කරන්න</button>
      ` : `
        <button class="btn small" onclick="finalඅනුමත(${r.id})">අවසාන අනුමැතිය</button>
      `}
      </td>
    </tr>`;
  }
  html += "</table></div>";
  qs("listBox").innerHTML = html;
}


async function overඅනුමත(id){
  try{
    await api(`/hr/requests/${id}/overbook/approve`, {method:"POST"});
    toast("ඔවරයිඩ් (+1/+2) අනුමත කරන ලදී. දැන් අවසාන අනුමැතිය ලබා දිය හැක.");
    await loadTARequests();
  }catch(e){ toast(e.message); }
}

async function overප්‍රතික්ෂේප(id){
  try{
    await api(`/hr/requests/${id}/overbook/reject`, {method:"POST"});
    toast("ඔවරයිඩ් ප්‍රතික්ෂේප කරන ලදී. TA වෙත නැවත යවයි (වාහන අමතර දාන්න/සකස් කරන්න).");
    await loadTARequests();
  }catch(e){ toast(e.message); }
}


async function finalඅනුමත(id){
  try{
    await api(`/hr/requests/${id}/final-approve`, {method:"POST"});
    toast("අවසාන අනුමැතිය ලබා දුන්නා. වාර්තා සූදානම්.");
    qs("repReqId").value = id;
    await loadTARequests();
  }catch(e){ toast(e.message); }
}

function downloadRouteReport(){
  const id = qs("repReqId").value.trim();
  if(!id){ toast("Enter request id"); return; }
  window.open(`${API_BASE_URL}/reports/route-wise?request_id=${encodeURIComponent(id)}`, "_blank");
}
function downloadVehicleReport(){
  const id = qs("repReqId").value.trim();
  if(!id){ toast("Enter request id"); return; }
  window.open(`${API_BASE_URL}/reports/vehicle?request_id=${encodeURIComponent(id)}`, "_blank");
}

(async function init(){
  try{
    await guard();
    await loadTARequests();
  }catch(e){ toast(e.message); if(!maybeLogoutOnAuth(e)){} }
})();
</script>
</body>
</html>
